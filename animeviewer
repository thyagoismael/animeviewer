#!/bin/sh
#
# Autor: Thyago Ismael
#


DIR_CONFIG=$HOME/.config/animeviewer
ARQ_LINKS=$DIR_CONFIG/links
MENU='dmenu -i -l 10'
PLAYER=mpv

criarArquivos()
{
    # Cria a pasta caso não exista
    test -d $DIR_CONFIG || mkdir -p $DIR_CONFIG

    # Cria o arquivo de links
    test -f $ARQ_LINKS || touch $ARQ_LINKS
}


removerHTML()
{
    echo "$1" | sed 's/^.*href="// ; s/" [^"]*"/\t/ ; s/".*// ; s/ /_/g ; s/_Online//' | tr '\t' ' '
}

getLinks()
{
    MAIOR_PAGINA=3
    TEMP=$(mktemp)

    LINKS="https://animesonline.vip/animes/"
    for pagina in $(seq 2 $MAIOR_PAGINA)
    do
        LINKS="$LINKS https://animesonline.vip/animes/page/$pagina/"
    done

    echo -n "Baixando nomes dos animes... "
    removerHTML "$(curl -s $LINKS | grep '^<a itemp')" >> $TEMP

    # Ordenando
    sort -u $TEMP > $ARQ_LINKS
    rm $TEMP
    
    # Acabou
    echo -e "Pronto!\n$(wc -l $ARQ_LINKS | cut -d' ' -f1) animes salvos"
}

selecionarAnime()
{
    # Mostra um menu com os nomes, depois busca o link relacionado
    grep "$(cut --fields 2 < $ARQ_LINKS  | $MENU -p 'Escolha o título: ')" $ARQ_LINKS | cut -d' ' -f 1
}

selecionarEpisodio()
{
    # $1 é o link do anime
   removerHTML "$(curl -s $1 | grep '^<a href=".*Epis')" |
   $MENU -p 'Escolha o episódio: ' | awk '{print $1}' |
   xargs -rI{} $PLAYER {}
#curl -s https://animesonline.vip/a-familia-dracula/ | grep '^<a href=".*Epis' 
}
